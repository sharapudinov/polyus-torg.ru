(function(){"use strict";BX.namespace("BX.Grid");BX.Grid.SettingsWindow=function(t){this.parent=null;this.settingsButton=null;this.applyBottom=null;this.items=null;this.popup=null;this.sourceContent=null;this.lastColumns=null;this.init(t)};BX.Grid.SettingsWindow.prototype={init:function(t){this.parent=t;BX.bind(this.parent.getContainer(),"click",BX.proxy(this._onContainerClick,this));BX.addCustomEvent(window,"Grid::columnMoved",BX.proxy(this._onColumnMoved,this))},reset:function(){this.items=null;this.allColumns=null;this.showedColumns=null},destroy:function(){BX.unbind(this.parent.getContainer(),"click",BX.proxy(this._onContainerClick,this));BX.removeCustomEvent(window,"Grid::columnMoved",BX.proxy(this._onColumnMoved,this));this.getPopup().close()},_onContainerClick:function(t){if(BX.hasClass(t.target,this.parent.settings.get("classSettingsButton"))){this._onSettingsButtonClick(t)}},_onSettingsButtonClick:function(t){this.getPopup().show()},getSourceContent:function(){if(!this.sourceContent){this.sourceContent=BX.Grid.Utils.getByClass(this.parent.getContainer(),this.parent.settings.get("classSettingsWindow"),true)}return this.sourceContent},getPopupItems:function(){var t;if(!this.items){t=this.getPopup().contentContainer;this.items=BX.Grid.Utils.getByClass(t,this.parent.settings.get("classSettingsWindowColumn"))}return this.items},getColumns:function(){var t=this.getPopupItems();var e=[];var n;t.forEach(function(t){n=this.findColumnCheckbox(t);if(n&&n.checked){e.push(BX.data(t,"name"))}},this);return e},restoreColumns:function(){var t=this.parent.getParam("DEFAULT_COLUMNS");this.getPopupItems().forEach(function(e){var n=BX.data(e,"name");var i=this.findColumnCheckbox(e);var s=this.findColumnLabel(e);var o=t[n];i.checked=o.default?true:null;BX.html(s,BX.util.htmlspecialchars(o.name))},this);this.sortItems();this.reset()},restoreLastColumns:function(){this.getPopupItems().forEach(function(t){if(this.lastColumns.indexOf(BX.data(t,"name"))===-1){var e=this.findColumnCheckbox(t);if(e){e.checked=null}}},this)},saveColumns:function(t,e){var n=this.parent;var i=n.getUserOptions();var s=this.getColumnNames();var o=this.isForAll();n.tableFade();i.setColumns(t,function(){i.setColumnsNames(s,function(){if(o){i.saveForAll(function(){n.reloadTable(null,null,e)})}else{n.reloadTable(null,null,e)}})})},resetSettings:function(t){var e=this.isForAll();var n={CONFIRM:true,CONFIRM_MESSAGE:this.parent.arParams.CONFIRM_RESET_MESSAGE};this.parent.getActionsPanel().confirmDialog(n,BX.delegate(function(){this.parent.tableFade();BX.addClass(t.buttonNode,"webform-small-button-wait");BX.removeClass(t.buttonNode,"popup-window-button");this.parent.getUserOptions().reset(e,BX.delegate(function(){this.parent.reloadTable(null,null,BX.delegate(function(){this.restoreColumns();this.lastColumns=this.getColumns();BX.removeClass(t.buttonNode,"webform-small-button-wait");BX.addClass(t.buttonNode,"popup-window-button");t.popupWindow.close()},this))},this))},this))},enableColumnLabelEdit:function(t){t&&(t.contentEditable=true)&&this.adjustCaret(t)&&t.focus()},disableColumnLabelEdit:function(t){t&&(t.contentEditable=false)},disableAllColumnslabelEdit:function(){this.getPopupItems().forEach(function(t){var e=this.findColumnLabel(t);var n=this.findColumnCheckbox(t);this.disableColumnLabelEdit(e);this.enableCheckbox(n)},this)},isColumnLabelEditEnabled:function(t){return t&&t.isContentEditable},isEditButton:function(t){return!!t&&BX.hasClass(t,this.parent.settings.get("classSettingsWindowColumnEditButton"))},findColumnLabel:function(t){return BX.Grid.Utils.getByTag(t,"label",true)},findColumnCheckbox:function(t){return BX.Grid.Utils.getBySelector(t,'input[type="checkbox"]',true)},disableCheckbox:function(t){t&&(t.disabled=true)},enableCheckbox:function(t){t&&(t.disabled=false)},adjustCaret:function(t){if(t&&t.childNodes.length){var e=document.createRange();var n=window.getSelection();var i=t.innerText.length;var s=t.childNodes;var o=s[s.length-1];e.setStart(o,i);e.setEnd(o,i);e.collapse(true);n.removeAllRanges();n.addRange(e)}},_onColumnClick:function(t){var e=t.currentTarget;var n=t.target;if(this.isEditButton(n)){var i=this.findColumnLabel(e);var s=this.findColumnCheckbox(e);if(!this.isColumnLabelEditEnabled(i)){this.enableColumnLabelEdit(i);this.disableCheckbox(s)}else{this.disableColumnLabelEdit(i);this.enableCheckbox(s)}}},_onColumnKeydown:function(t){if(t.code==="Enter"){var e=t.currentTarget;BX.removeClass(e,this.parent.settings.get("classSettingsWindowColumnEditState"));var n=BX.Grid.Utils.getByClass(e,this.parent.settings.get("classSettingsWindowColumnEditInput"),true);var i=BX.Grid.Utils.getByClass(e,this.parent.settings.get("classSettingsWindowColumnLabel"),true);if(i){BX.html(i,BX.util.htmlspecialchars(n.value))}}},getAllColumns:function(){if(!this.allColumns){this.allColumns=this.getPopupItems().map(function(t){return BX.data(t,"name")})}return this.allColumns},getShowedColumns:function(){if(!this.showedColumns){this.showedColumns=[];[].forEach.call(this.parent.getRows().getHeadFirstChild().getCells(),function(t){var e=BX.data(t,"name");e&&this.showedColumns.push(e)},this)}return this.showedColumns},isShowedColumn:function(t){return this.getShowedColumns().some(function(e){return e===t})},sortItems:function(){var t=this.getShowedColumns();var e={};this.getAllColumns().forEach(function(t){e[t]=t},this);var n=0;Object.keys(e).forEach(function(i){if(this.isShowedColumn(i)){e[i]=t[n];n++}var s=this.getColumnByName(e[i]);s&&s.parentNode.appendChild(s)},this)},getColumnNames:function(){var t=this.getPopupItems();var e={};t.forEach(function(t){var n=BX.data(t,"name");var i=this.findColumnLabel(t);e[n]=BX.util.htmlspecialchars(BX.util.htmlspecialcharsback(i.innerText.trim()))},this);return e},getColumnByName:function(t){return BX.Grid.Utils.getBySelector(this.getPopup().popupContainer,"."+this.parent.settings.get("classSettingsWindowColumn")+'[data-name="'+t+'"]',true)},_onColumnMoved:function(){this.sortItems();this.reset()},getPopup:function(){var t=this;if(!this.popup){var e=BX.create("div");e.innerHTML="<span>"+this.parent.getParam("SETTINGS_TITLE")+" &laquo;"+BX("pagetitle").innerText+"&raquo;</span>";var n=e.firstChild;this.popup=new BX.PopupWindow(this.parent.getContainerId()+"-grid-settings-window",null,{titleBar:n.innerText,autoHide:false,overlay:.6,width:800,closeIcon:true,closeByEsc:true,contentNoPaddings:true,events:{onPopupClose:BX.delegate(function(){this.restoreLastColumns();this.disableAllColumnslabelEdit()},this)},buttons:[new BX.PopupWindowButtonLink({text:this.parent.getParam("RESET_DEFAULT"),id:this.parent.getContainerId()+"-grid-settings-reset-button",className:"main-grid-settings-window-actions-item-reset",events:{click:function(){t.resetSettings(this.popupWindow.buttons[1])}}}),new BX.PopupWindowButton({text:this.parent.getParam("APPLY_SETTINGS"),id:this.parent.getContainerId()+"-grid-settings-apply-button",className:"webform-small-button-blue webform-small-button",events:{click:function(){t.parent.getActionsPanel().confirmDialog({CONFIRM:t.isForAll(),CONFIRM_MESSAGE:t.parent.getParam("SETTINGS_FOR_ALL_CONFIRM_MESSAGE")},BX.delegate(function(){BX.addClass(this.buttonNode,"webform-small-button-wait");BX.removeClass(this.buttonNode,"popup-window-button");t.lastColumns=t.getColumns();t.saveColumns(t.lastColumns,BX.delegate(function(){this.popupWindow.close();BX.removeClass(this.buttonNode,"webform-small-button-wait");BX.addClass(this.buttonNode,"popup-window-button");var e=t.getForAllCheckbox();e&&(e.checked=null)},this))},this),BX.delegate(function(){var e=t.getForAllCheckbox();e&&(e.checked=null)},this))}}}),new BX.PopupWindowButtonLink({text:this.parent.getParam("CANCEL_SETTINGS"),id:this.parent.getContainerId()+"-grid-settings-cancel-button",events:{click:function(){this.popupWindow.close();t.restoreLastColumns()}}})]});if(this.parent.getParam("IS_ADMIN")){var i=this.createCheckbox();var s=this.getResetButton();BX.insertAfter(i,s)}this.popup.setContent(this.getSourceContent());this.lastColumns=this.getColumns();this.getPopupItems().forEach(function(t){BX.bind(t,"click",BX.delegate(this._onColumnClick,this));BX.bind(t,"keydown",BX.delegate(this._onColumnKeydown,this))},this)}return this.popup},isForAll:function(){var t=this.getForAllCheckbox();return t&&!!t.checked},getForAllCheckbox:function(){return BX.Grid.Utils.getByClass(this.getPopup().popupContainer,"main-grid-settings-window-for-all-checkbox",true)},getResetButton:function(){return BX.Grid.Utils.getByClass(this.getPopup().popupContainer,"main-grid-settings-window-actions-item-reset",true)},createCheckbox:function(){var t="main-grid-settings-window-for-all-checkbox_"+this.parent.getParam("GRID_ID");return BX.decl({block:"popup-window-button",mix:["popup-window-button-link","main-grid-settings-window-for-all"],tag:"span",content:[{block:"main-grid-settings-window-for-all-checkbox",tag:"input",attrs:{name:"grid-settings-window-for-all",type:"checkbox",id:t}},{block:"main-grid-settings-window-for-all-label",tag:"label",attrs:{"for":t},content:this.parent.getParam("SETTINGS_FOR_ALL_LABEL")}]})}}})();
//# sourceMappingURL=settings-window.map.js