(function(){"use strict";BX.namespace("BX.Grid");BX.Grid.RowsSortable=function(t){this.parent=null;this.list=null;this.setDefaultProps();this.init(t)};BX.Grid.RowsSortable.prototype={init:function(t){this.parent=t;this.list=this.getList();this.prepareListItems();jsDD.Enable();if(!this.inited){this.inited=true;this.onscrollDebounceHandler=BX.debounce(this._onWindowScroll,300,this);BX.addCustomEvent("Grid::thereEditedRows",BX.proxy(this.disable,this));BX.addCustomEvent("Grid::noEditedRows",BX.proxy(this.enable,this));BX.bind(window,"scroll",this.onscrollDebounceHandler)}},destroy:function(){BX.removeCustomEvent("Grid::thereEditedRows",BX.proxy(this.disable,this));BX.removeCustomEvent("Grid::noEditedRows",BX.proxy(this.enable,this));BX.unbind(window,"scroll",this.onscrollDebounceHandler);this.unregisterObjects()},_onWindowScroll:function(){this.windowScrollTop=BX.scrollTop(window)},disable:function(){this.unregisterObjects()},enable:function(){this.reinit()},reinit:function(){this.unregisterObjects();this.setDefaultProps();this.init(this.parent)},getList:function(){return this.parent.getRows().getSourceBodyChild()},unregisterObjects:function(){this.list=this.list.map(function(t){jsDD.unregisterObject(t);return t})},prepareListItems:function(){var t=this;this.list=this.list.map(function(s){s.onbxdragstart=BX.delegate(t._onDragStart,t);s.onbxdrag=BX.delegate(t._onDrag,t);s.onbxdragstop=BX.delegate(t._onDragEnd,t);jsDD.registerObject(s);return s})},getIndex:function(t){return BX.Grid.Utils.getIndex(this.list,t)},_onDragStart:function(){this.dragItem=jsDD.current_node;this.dragIndex=this.getIndex(this.dragItem);this.dragRect=this.getRowRect(this.dragItem,this.dragIndex);this.offset=this.dragRect.height;this.dragStartOffset=jsDD.start_y-(this.dragRect.top+this.getWindowScrollTop());BX.Grid.Utils.styleForEach(this.list,{transition:+this.parent.settings.get("animationDuration")+"ms"});BX.bind(document,"mousemove",BX.delegate(this._onMouseMove,this));BX.addClass(this.parent.getContainer(),this.parent.settings.get("classOnDrag"));BX.addClass(this.dragItem,this.parent.settings.get("classDragActive"))},_onMouseMove:function(t){this.realX=t.clientX;this.realY=t.clientY},moveRow:function(t,s,e){if(!!t){var i=BX.type.isNumber(e)?e:300;t.style.transition=i+"ms";t.style.transform="translate3d(0px, "+s+"px, 0px)"}},getDragOffset:function(){return this.realY-this.dragRect.top-this.dragStartOffset},getWindowScrollTop:function(){if(this.windowScrollTop===null){this.windowScrollTop=BX.scrollTop(window)}return this.windowScrollTop},getSortOffset:function(){return this.realY+this.getWindowScrollTop()},getRowRect:function(t,s){if(!this.rowsRectList){this.rowsRectList={};this.list.forEach(function(t,s){return this.rowsRectList[s]=t.getBoundingClientRect()},this)}return this.rowsRectList[s]},getRowCenter:function(t,s){var e=this.getRowRect(t,s);return e.top+this.getWindowScrollTop()+e.height/2},isDragToBottom:function(t,s){var e=this.getRowCenter(t,s);var i=this.getSortOffset();return s>this.dragIndex&&e<i},isMovedToBottom:function(t){return t.style.transform==="translate3d(0px, "+-this.offset+"px, 0px)"},isDragToTop:function(t,s){var e=this.getRowCenter(t,s);var i=this.getSortOffset();return s<this.dragIndex&&e>i},isMovedToTop:function(t){return t.style.transform==="translate3d(0px, "+this.offset+"px, 0px)"},isDragToBack:function(t,s){var e=this.getRowCenter(t,s);var i=this.dragIndex;var n=jsDD.y;return s>i&&n<e||s<i&&n>e},isMoved:function(t){return t.style.transform!=="translate3d(0px, 0px, 0px)"&&t.style.transform!==""},_onDrag:function(){var t=0;var s=0;this.moveRow(this.dragItem,this.getDragOffset(),t);this.list.forEach(function(t,e){if(!!t){if(this.isDragToTop(t,e)&&!this.isMovedToTop(t)){this.targetItem=t;this.moveRow(t,this.offset)}if(this.isDragToBottom(t,e)&&!this.isMovedToBottom(t)){this.targetItem=t;this.moveRow(t,-this.offset)}if(this.isDragToBack(t,e)&&this.isMoved(t)){this.targetItem=t;this.moveRow(t,s)}}},this)},_onDragOver:function(){},_onDragLeave:function(){},_onDragEnd:function(){BX.unbind(document,"mousemove",BX.delegate(this._onMouseMove,this));BX.removeClass(this.parent.getContainer(),this.parent.settings.get("classOnDrag"));BX.removeClass(this.dragItem,this.parent.settings.get("classDragActive"));BX.Grid.Utils.styleForEach(this.list,{transition:"",transform:""});BX.Grid.Utils.collectionSort(this.dragItem,this.targetItem);this.list=this.getList();this.parent.getRows().reset();var t=this.parent.getRows().get(this.dragItem);var s=this.parent.getRows().getBodyChild().map(function(t){return t.getId()});this.saveRowsSort(s);BX.onCustomEvent(window,"Grid::rowMoved",[s,t,this.parent]);this.setDefaultProps()},saveRowsSort:function(t){var s={ids:t,action:this.parent.getUserOptions().getAction("GRID_SAVE_ROWS_SORT")};this.parent.getData().request(null,"POST",s)},setDefaultProps:function(){this.dragItem=null;this.targetItem=null;this.dragRect=null;this.dragIndex=null;this.offset=null;this.realX=null;this.realY=null;this.dragStartOffset=null;this.windowScrollTop=null;this.rowsRectList=null}}})();
//# sourceMappingURL=rows-sortable.map.js